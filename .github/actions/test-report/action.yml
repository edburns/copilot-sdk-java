name: "Test Report"
description: "Generate and publish test reports with summary for Java SDK tests."
inputs:
  report-path:
    description: "Path to the test report XML files (glob pattern)"
    required: false
    default: "target/surefire-reports/TEST-*.xml"
  jacoco-path:
    description: "Path to the JaCoCo XML report"
    required: false
    default: "target/site/jacoco-coverage/jacoco.xml"
  check-name:
    description: "Name for the check run"
    required: false
    default: "Java SDK Test Results"
runs:
  using: "composite"
  steps:
    - name: Generate Test Summary
      shell: bash
      run: |
        echo "## ðŸ§ª Java SDK Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        REPORT_DIR=$(dirname "${{ inputs.report-path }}")
        REPORT_PATTERN=$(basename "${{ inputs.report-path }}")

        if [ -d "$REPORT_DIR" ]; then
          TESTS_RUN=$(grep -h "tests=" ${{ inputs.report-path }} 2>/dev/null | sed 's/.*tests="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
          FAILURES=$(grep -h "failures=" ${{ inputs.report-path }} 2>/dev/null | sed 's/.*failures="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
          ERRORS=$(grep -h "errors=" ${{ inputs.report-path }} 2>/dev/null | sed 's/.*errors="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
          SKIPPED=$(grep -h "skipped=" ${{ inputs.report-path }} 2>/dev/null | sed 's/.*skipped="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')

          TESTS_RUN=${TESTS_RUN:-0}
          FAILURES=${FAILURES:-0}
          ERRORS=${ERRORS:-0}
          SKIPPED=${SKIPPED:-0}
          PASSED=$((TESTS_RUN - FAILURES - ERRORS - SKIPPED))

          if [ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ]; then
            echo "### âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | $FAILURES |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ’¥ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Total | $TESTS_RUN |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Classes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Class | Tests | Passed | Failed | Errors | Time |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|--------|--------|--------|------|" >> $GITHUB_STEP_SUMMARY

          for file in ${{ inputs.report-path }}; do
            if [ -f "$file" ]; then
              CLASS=$(basename "$file" .xml | sed 's/TEST-//')
              T=$(grep -o 'tests="[0-9]*"' "$file" | head -1 | sed 's/[^0-9]//g')
              F=$(grep -o 'failures="[0-9]*"' "$file" | head -1 | sed 's/[^0-9]//g')
              E=$(grep -o 'errors="[0-9]*"' "$file" | head -1 | sed 's/[^0-9]//g')
              TIME=$(grep -o 'time="[0-9.]*"' "$file" | head -1 | sed 's/[^0-9.]//g')
              P=$((T - F - E))

              STATUS="âœ…"
              if [ "${F:-0}" -gt 0 ] || [ "${E:-0}" -gt 0 ]; then
                STATUS="âŒ"
              fi

              echo "| $STATUS $CLASS | ${T:-0} | ${P:-0} | ${F:-0} | ${E:-0} | ${TIME:-0}s |" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "âš ï¸ No test reports found at ${{ inputs.report-path }}" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Generate Coverage Summary
      shell: bash
      run: |
        JACOCO_XML="${{ inputs.jacoco-path }}"
        
        if [ -f "$JACOCO_XML" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # JaCoCo XML may be on a single line - split it for parsing
          # Extract report-level counters (last occurrence of each type before </report>)
          extract_counter() {
            local type=$1
            local field=$2
            # Split XML on > to get one tag per line, find counter, extract value
            sed 's/>/>\n/g' "$JACOCO_XML" | grep "<counter type=\"$type\"" | tail -1 | sed "s/.*$field=\"\([0-9]*\)\".*/\1/"
          }
          
          INSTR_MISSED=$(extract_counter "INSTRUCTION" "missed")
          INSTR_COVERED=$(extract_counter "INSTRUCTION" "covered")
          
          BRANCH_MISSED=$(extract_counter "BRANCH" "missed")
          BRANCH_COVERED=$(extract_counter "BRANCH" "covered")
          
          LINE_MISSED=$(extract_counter "LINE" "missed")
          LINE_COVERED=$(extract_counter "LINE" "covered")
          
          METHOD_MISSED=$(extract_counter "METHOD" "missed")
          METHOD_COVERED=$(extract_counter "METHOD" "covered")
          
          CLASS_MISSED=$(extract_counter "CLASS" "missed")
          CLASS_COVERED=$(extract_counter "CLASS" "covered")
          
          # Calculate percentages
          calc_pct() {
            local covered=$1
            local missed=$2
            if [ -n "$covered" ] && [ -n "$missed" ]; then
              local total=$((covered + missed))
              if [ "$total" -gt 0 ]; then
                echo "scale=1; $covered * 100 / $total" | bc
              else
                echo "0"
              fi
            else
              echo "N/A"
            fi
          }
          
          INSTR_PCT=$(calc_pct "${INSTR_COVERED:-0}" "${INSTR_MISSED:-0}")
          BRANCH_PCT=$(calc_pct "${BRANCH_COVERED:-0}" "${BRANCH_MISSED:-0}")
          LINE_PCT=$(calc_pct "${LINE_COVERED:-0}" "${LINE_MISSED:-0}")
          METHOD_PCT=$(calc_pct "${METHOD_COVERED:-0}" "${METHOD_MISSED:-0}")
          CLASS_PCT=$(calc_pct "${CLASS_COVERED:-0}" "${CLASS_MISSED:-0}")
          
          echo "| Metric | Covered | Missed | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Instructions | ${INSTR_COVERED:-0} | ${INSTR_MISSED:-0} | ${INSTR_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Branches | ${BRANCH_COVERED:-0} | ${BRANCH_MISSED:-0} | ${BRANCH_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Lines | ${LINE_COVERED:-0} | ${LINE_MISSED:-0} | ${LINE_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Methods | ${METHOD_COVERED:-0} | ${METHOD_MISSED:-0} | ${METHOD_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Classes | ${CLASS_COVERED:-0} | ${CLASS_MISSED:-0} | ${CLASS_PCT}% |" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ No JaCoCo report found at $JACOCO_XML" >> $GITHUB_STEP_SUMMARY
        fi
