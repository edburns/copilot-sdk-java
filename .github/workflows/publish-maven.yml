name: Publish Java SDK to Maven Central

env:
    HUSKY: 0

on:
    workflow_dispatch:
        inputs:
            releaseVersion:
                description: "Release version (e.g., 1.0.0). If empty, derives from pom.xml by removing -SNAPSHOT"
                required: false
                type: string
            developmentVersion:
                description: "Next development version (e.g., 1.0.1-SNAPSHOT). If empty, increments patch version"
                required: false
                type: string
            prerelease:
                description: "Is this a prerelease?"
                type: boolean
                required: false
                default: false

permissions:
    contents: write
    id-token: write

concurrency:
    group: publish-maven
    cancel-in-progress: false

jobs:
    publish-maven:
        name: Publish Java SDK to Maven Central
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.versions.outputs.release_version }}
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configure Git for Maven Release
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - uses: ./.github/actions/setup-copilot

            - name: Set up JDK 17
              uses: actions/setup-java@v5
              with:
                  java-version: "17"
                  distribution: "temurin"
                  server-id: central
                  server-username: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
                  server-password: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
                  gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
                  gpg-passphrase: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

            - name: Determine versions
              id: versions
              run: |
                  CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
                  echo "Current pom.xml version: $CURRENT_VERSION"
                  
                  # Determine release version
                  if [ -n "${{ inputs.releaseVersion }}" ]; then
                    RELEASE_VERSION="${{ inputs.releaseVersion }}"
                  else
                    # Remove -SNAPSHOT suffix if present
                    RELEASE_VERSION="${CURRENT_VERSION%-SNAPSHOT}"
                  fi
                  echo "Release version: $RELEASE_VERSION"
                  
                  # Determine next development version
                  if [ -n "${{ inputs.developmentVersion }}" ]; then
                    DEV_VERSION="${{ inputs.developmentVersion }}"
                  else
                    # Increment patch version and add -SNAPSHOT
                    IFS='.' read -r MAJOR MINOR PATCH <<< "$RELEASE_VERSION"
                    NEXT_PATCH=$((PATCH + 1))
                    DEV_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-SNAPSHOT"
                  fi
                  echo "Next development version: $DEV_VERSION"
                  
                  echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
                  echo "dev_version=$DEV_VERSION" >> $GITHUB_OUTPUT
                  
                  echo "### Version Summary" >> $GITHUB_STEP_SUMMARY
                  echo "- **Release version:** $RELEASE_VERSION" >> $GITHUB_STEP_SUMMARY
                  echo "- **Next development version:** $DEV_VERSION" >> $GITHUB_STEP_SUMMARY

            - name: Prepare Release
              run: |
                  mvn -B release:prepare \
                    -DreleaseVersion=${{ steps.versions.outputs.release_version }} \
                    -DdevelopmentVersion=${{ steps.versions.outputs.dev_version }} \
                    -DtagNameFormat=v@{project.version} \
                    -DpushChanges=true \
                    -Darguments="-DskipTests"

            - name: Perform Release and Deploy to Maven Central
              run: |
                  mvn -B release:perform \
                    -Dgoals="deploy" \
                    -Darguments="-DskipTests -Prelease"

            - name: Update documentation with the released version
              run: |
                  VERSION="${{ steps.versions.outputs.release_version }}"
                  
                  # Update version in README.md
                  sed -i "s|<version>[0-9]*\.[0-9]*\.[0-9]*</version>|<version>${VERSION}</version>|g" README.md
                  sed -i "s|copilot-sdk:[0-9]*\.[0-9]*\.[0-9]*|copilot-sdk:${VERSION}|g" README.md
                  
                  # Update version in jbang-example.java
                  sed -i "s|copilot-sdk:[0-9]*\.[0-9]*\.[0-9]*|copilot-sdk:${VERSION}|g" jbang-example.java
                  
                  # Stage the documentation changes (will be committed by release:prepare)
                  git add README.md jbang-example.java

                  # Commit
                  git commit -m "Update documentation for version ${VERSION}"
    github-release:
        name: Create GitHub Release
        needs: publish-maven
        if: github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0
            - name: Create GitHub Release
              run: |
                  VERSION="${{ needs.publish-maven.outputs.version }}"
                  GROUP_ID="io.github.copilot-community-sdk"
                  ARTIFACT_ID="copilot-sdk"
                  
                  RELEASE_NOTES=$(cat <<EOF
                  # Installation

                  ðŸ“¦ [View on Maven Central](https://central.sonatype.com/artifact/${GROUP_ID}/${ARTIFACT_ID}/${VERSION})

                  ## Maven
                  \`\`\`xml
                  <dependency>
                      <groupId>${GROUP_ID}</groupId>
                      <artifactId>${ARTIFACT_ID}</artifactId>
                      <version>${VERSION}</version>
                  </dependency>
                  \`\`\`

                  ## Gradle (Kotlin DSL)
                  \`\`\`kotlin
                  implementation("${GROUP_ID}:${ARTIFACT_ID}:${VERSION}")
                  \`\`\`

                  ## Gradle (Groovy DSL)
                  \`\`\`groovy
                  implementation '${GROUP_ID}:${ARTIFACT_ID}:${VERSION}'
                  \`\`\`

                  EOF
                  )
                  
                  gh release create "v${VERSION}" \
                    ${{ inputs.prerelease == true && '--prerelease' || '' }} \
                    --title "Java SDK v${VERSION}" \
                    --notes "${RELEASE_NOTES}" \
                    --generate-notes \
                    --target "v${VERSION}"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
