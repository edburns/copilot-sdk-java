name: Publish Java SDK to Maven Central

env:
    HUSKY: 0

on:
    workflow_dispatch:
        inputs:
            version:
                description: "Version to publish (optional). If empty, uses version from pom.xml."
                type: string
                required: false
            prerelease:
                description: "Is this a prerelease?"
                type: boolean
                required: false
                default: false

permissions:
    contents: write
    id-token: write

concurrency:
    group: publish-maven
    cancel-in-progress: false

jobs:
    publish-maven:
        name: Publish Java SDK to Maven Central
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.get-version.outputs.version }}
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configure Git for Maven Release
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - uses: ./.github/actions/setup-copilot

            - name: Set up JDK 17
              uses: actions/setup-java@v5
              with:
                  java-version: "17"
                  distribution: "temurin"
                  server-id: central
                  server-username: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
                  server-password: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
                  gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
                  gpg-passphrase: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

            - name: Set version in pom.xml
              if: ${{ github.event.inputs.version != '' }}
              run: mvn versions:set -DnewVersion=${{ github.event.inputs.version }} -DgenerateBackupPoms=false

            - name: Get version
              id: get-version
              run: |
                  VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Publishing version: $VERSION" >> $GITHUB_STEP_SUMMARY

            - name: Build and Deploy to Maven Central
              run: mvn verify deploy -DskipTests -Prelease
              env:
                  MAVEN_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
                  MAVEN_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
                  MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
                  MAVEN_GPG_PRIVATE_KEY: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}

    github-release:
        name: Create GitHub Release
        needs: publish-maven
        if: github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
            - name: Create GitHub Release
              run: |
                  VERSION="${{ needs.publish-maven.outputs.version }}"
                  GROUP_ID="io.github.copilot-community-sdk"
                  ARTIFACT_ID="copilot-sdk"
                  
                  RELEASE_NOTES=$(cat <<EOF
                  # Installation

                  ðŸ“¦ [View on Maven Central](https://central.sonatype.com/artifact/${GROUP_ID}/${ARTIFACT_ID}/${VERSION})

                  ## Maven
                  \`\`\`xml
                  <dependency>
                      <groupId>${GROUP_ID}</groupId>
                      <artifactId>${ARTIFACT_ID}</artifactId>
                      <version>${VERSION}</version>
                  </dependency>
                  \`\`\`

                  ## Gradle (Kotlin DSL)
                  \`\`\`kotlin
                  implementation("${GROUP_ID}:${ARTIFACT_ID}:${VERSION}")
                  \`\`\`

                  ## Gradle (Groovy DSL)
                  \`\`\`groovy
                  implementation '${GROUP_ID}:${ARTIFACT_ID}:${VERSION}'
                  \`\`\`

                  EOF
                  )
                  
                  gh release create "${VERSION}" \
                    ${{ github.event.inputs.prerelease == 'true' && '--prerelease' || '' }} \
                    --title "Java SDK v${VERSION}" \
                    --notes "${RELEASE_NOTES}" \
                    --generate-notes \
                    --target ${{ github.sha }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
