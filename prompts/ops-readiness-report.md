# Ops Readiness Report: `copilot-sdk-java`

This document describes the operational infrastructure that allows `copilot-sdk-java` to remain in sync with the upstream `copilot-sdk/dotnet` implementation with minimal human effort.

## The Upstream Sync Loop

The central automation is a fully agentic workflow that keeps the Java SDK synchronized with the .NET reference implementation at `github/copilot-sdk`. The loop runs continuously with near-zero human toil:

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Weekly Upstream Sync Loop                        │
│                                                                     │
│  ┌───────────────┐    ┌──────────────┐    ┌──────────────────────┐  │
│  │ Cron trigger  │───▶│ Detect new   │───▶│ Create GitHub issue  │  │
│  │ (Mon 10:00    │    │ upstream     │    │ assigned to Copilot  │  │
│  │  UTC)         │    │ commits      │    │ coding agent         │  │
│  └───────────────┘    └──────────────┘    └──────────┬───────────┘  │
│                                                      │              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────▼───────────┐   │
│  │ Human:       │◀───│ PR created   │◀───│ Agent follows        │   │
│  │ review &     │    │ with changes │    │ agentic-merge-       │   │
│  │ merge        │    │ + label      │    │ upstream prompt      │   │
│  └──────┬───────┘    └──────────────┘    └──────────────────────┘   │
│         │                                                           │
│  ┌──────▼────────┐    ┌──────────────┐    ┌──────────────────────┐  │
│  │ Build & Test  │───▶│ Deploy docs  │───▶│ .lastmerge updated   │  │
│  │ CI runs       │    │ to GH Pages  │    │ (loop resets)        │  │
│  └───────────────┘    └──────────────┘    └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### How it works, step by step

1. **Detection** (`weekly-upstream-sync.yml`): Every Monday at 10:00 UTC, a GitHub Actions workflow reads `.lastmerge` (a single file containing the SHA of the last upstream commit merged into the Java SDK), clones `github/copilot-sdk`, and compares `HEAD` against the stored SHA.

2. **Issue creation**: If new commits are found, the workflow closes any stale `upstream-sync` issues, then creates a new issue titled "Upstream sync: N new commits (YYYY-MM-DD)" with the commit summary, and assigns it to `copilot` (the GitHub Copilot coding agent).

3. **Agentic merge**: The Copilot coding agent picks up the issue and follows the `agentic-merge-upstream.prompt.md` instructions. It runs shell scripts to create a branch, analyze the upstream diff, port changes to Java idioms, run tests, update `.lastmerge`, and push. The agent commits incrementally and adds the `upstream-sync` label to the PR.

4. **Human review**: A maintainer reviews the PR. This is the only manual step in the loop.

5. **CI validation**: The `build-test.yml` workflow runs on the PR — Spotless formatting check, compilation, Javadoc generation, and the full test suite against the replaying test harness.

6. **Post-merge**: After merge to `main`, the `deploy-site.yml` workflow publishes updated documentation to GitHub Pages.

7. **Loop resets**: The updated `.lastmerge` file on `main` means the next weekly check finds no new commits (or only commits added after this merge).

### Human effort per cycle

| Step | Actor | Effort |
|---|---|---|
| Detection + issue creation | Automated (cron) | None |
| Porting code changes | Copilot coding agent | None |
| PR review + merge | Human maintainer | ~10–30 min/week |
| CI + docs deployment | Automated (on merge) | None |

---

## File Inventory

### GitHub Actions Workflows

| File | Purpose |
|---|---|
| `.github/workflows/weekly-upstream-sync.yml` | Cron-triggered workflow that detects upstream changes and creates an issue assigned to `copilot`. Closes stale `upstream-sync` issues automatically. |
| `.github/workflows/weekly-upstream-sync.md` | Agentic workflow description (gh-aw format) that mirrors the `.yml` workflow for the GitHub Agentic Workflows system. |
| `.github/workflows/weekly-upstream-sync.lock.yml` | Compiled lock file generated by `gh aw compile` from the `.md` agentic workflow. Auto-generated — do not edit. |
| `.github/workflows/build-test.yml` | CI workflow: runs on push to `main`, PRs, and weekly. Checks Spotless formatting, compiles, generates Javadoc, installs the Copilot CLI from the cloned test harness, runs `mvn verify`, uploads JaCoCo coverage artifacts, and generates a coverage badge. |
| `.github/workflows/deploy-site.yml` | Documentation deployment: triggered after `build-test.yml` succeeds on `main`, on release publish, or manually. Builds Maven site with JaCoCo/Surefire reports and deploys versioned documentation to GitHub Pages (`/snapshot/`, `/latest/`, `/vX.Y.Z/`). |
| `.github/workflows/publish-maven.yml` | Release workflow: manually triggered. Determines versions, updates documentation and changelog, runs `maven-release-plugin` to tag and deploy to Maven Central, creates a GitHub Release, and triggers site deployment. |
| `.github/workflows/copilot-setup-steps.yml` | Environment setup for the GitHub Copilot coding agent: installs `gh-aw` CLI extension, Node.js 22, and JDK 17. Required for the agent to operate in this repository. |

### Reusable Prompts (AI Agent Instructions)

| File | Purpose |
|---|---|
| `.github/prompts/agentic-merge-upstream.prompt.md` | Detailed step-by-step instructions for porting upstream .NET changes to Java. Covers diff analysis, type mappings (C# → Java), test porting, documentation updates, and PR creation. References shell scripts for automation. This is the core prompt that drives the agentic sync. |
| `.github/prompts/commit-as-pull-request.prompt.md` | Generic skill: takes uncommitted changes, auto-detects a branch name, builds, commits, pushes, creates a PR via GitHub MCP, squash-merges, and syncs local `main`. Used for ad-hoc changes. |
| `.github/prompts/documentation-coverage.prompt.md` | Assessment skill: inventories all public APIs in the SDK, maps them against `src/site/markdown/` documentation, and produces a coverage report with gaps and recommendations. |
| `.github/prompts/test-coverage-assessment.prompt.md` | Assessment skill: analyzes which event types, hook types, and core features have unit and E2E test coverage. Produces a gap report with prioritized recommendations. |

### Skills (Agent Capabilities)

Skills are registered in two locations (`.github/skills/` for GitHub-hosted agents, `.claude/skills/` for Claude Code). Each points to its corresponding prompt file.

| Skill | Description |
|---|---|
| `agentic-merge-upstream` | Invokes the upstream merge prompt. This is what the Copilot coding agent uses when it picks up an `upstream-sync` issue. |
| `commit-as-pull-request` | Invokes the commit-as-PR prompt. Useful for both agents and human developers working with AI assistants. |
| `documentation-coverage` | Invokes the documentation coverage assessment prompt. |

### Shell Scripts

| File | Purpose |
|---|---|
| `.github/scripts/upstream-sync/merge-upstream-start.sh` | Creates a feature branch, updates the CLI, clones upstream, reads `.lastmerge`, prints a commit summary. Writes a `.merge-env` file for subsequent scripts. |
| `.github/scripts/upstream-sync/merge-upstream-diff.sh` | Produces a detailed diff analysis grouped by area (.NET src, tests, snapshots, docs, protocol, other SDKs). Supports `--full` for complete diffs. |
| `.github/scripts/upstream-sync/merge-upstream-finish.sh` | Runs formatting + tests, updates `.lastmerge` to the new upstream HEAD, commits, and pushes the branch. Supports `--skip-tests`. |
| `.github/scripts/build/format-and-test.sh` | Standalone `mvn spotless:apply` + `mvn clean verify`. Supports `--format-only`, `--test-only`, `--debug` flags. |
| `.github/scripts/ci/parse-repo-info.sh` | Extracts `REPO_OWNER` and `REPO_NAME` from the git remote URL. |
| `.github/scripts/ci/commit-and-push.sh` | Stages, commits, and pushes to a named branch. Handles branch name collisions with numeric suffixes. |
| `.github/scripts/ci/sync-after-merge.sh` | Syncs local `main` after a PR merge and deletes the feature branch. |
| `.github/scripts/release/update-changelog.sh` | Converts `[Unreleased]` section in CHANGELOG.md to a versioned release, injects upstream sync commit hash from `.lastmerge`. |
| `.github/scripts/generate-coverage-badge.sh` | Generates a JaCoCo coverage badge SVG from test results. |

### Composite Actions

| File | Purpose |
|---|---|
| `.github/actions/setup-copilot/action.yml` | Installs Node.js 22 and the `@github/copilot` CLI globally. Used by CI workflows that need the Copilot CLI for E2E tests. |
| `.github/actions/test-report/` | Generates a test report summary in GitHub Actions. |

### Agent Configuration

| File | Purpose |
|---|---|
| `.github/agents/agentic-workflows.agent.md` | Dispatcher agent for GitHub Agentic Workflows (gh-aw). Routes requests to create, update, debug, or upgrade agentic workflows. |
| `.github/copilot-instructions.md` | Repository-wide instructions for any AI agent working in this codebase. Covers build commands, architecture, conventions, testing patterns, and boundaries. |
| `.github/aw/actions-lock.json` | Lock file for gh-aw action versions. |

### Key State Files

| File | Purpose |
|---|---|
| `.lastmerge` | Contains the SHA of the last upstream `github/copilot-sdk` commit merged into this repository. This is the sole state that drives the sync loop. Currently: `5016587a62652f3d184b3c6958dfc63359921aa8`. |
| `.github/release.yml` | Configuration for auto-generated GitHub Release notes. Categorizes PRs by label into Features, Bug Fixes, Documentation, and Maintenance. |

### Configuration & Templates

| File | Purpose |
|---|---|
| `.github/templates/index.html` | HTML template for the GitHub Pages version index page. |
| `.github/templates/styles.css` | CSS for the version index page. |
| `.github/dependabot.yml` | Dependabot configuration (if present). |

---

## Workflow Interactions

```
weekly-upstream-sync.yml
    │
    ├── creates issue → Copilot coding agent
    │                        │
    │                        ├── runs merge-upstream-start.sh
    │                        ├── runs merge-upstream-diff.sh
    │                        ├── ports changes (guided by agentic-merge-upstream.prompt.md)
    │                        ├── runs format-and-test.sh
    │                        ├── runs merge-upstream-finish.sh
    │                        └── pushes to PR branch
    │
    └── PR triggers build-test.yml
                        │
                        ├── spotless:check
                        ├── mvn test-compile
                        ├── javadoc:javadoc
                        ├── mvn verify (with Copilot CLI from test harness)
                        └── uploads test artifacts

After merge to main:
    build-test.yml (on push)
        │
        ├── full test suite
        ├── generates coverage badge
        └── uploads artifacts → deploy-site.yml
                                    │
                                    └── builds Maven site → GitHub Pages

On release:
    publish-maven.yml (manual trigger)
        │
        ├── update-changelog.sh (injects .lastmerge SHA)
        ├── maven-release-plugin (tag + deploy to Maven Central)
        ├── gh release create
        └── triggers deploy-site.yml (versioned docs)
```

---

## What a Typical Week Looks Like

### If upstream has changes

1. **Monday 10:00 UTC**: `weekly-upstream-sync.yml` fires, finds 3 new commits, creates issue #42 "Upstream sync: 3 new commits (2026-02-16)", assigns to `copilot`.
2. **Monday ~10:05 UTC**: Copilot coding agent picks up issue #42, creates branch `upstream-sync/2026-02-16`, analyzes the .NET diff, ports applicable changes to Java, runs tests, pushes.
3. **Monday ~10:30 UTC**: PR appears with the `upstream-sync` label. `build-test.yml` CI runs and passes.
4. **Anytime that week**: Maintainer reviews the PR (~10–30 min), merges. Docs auto-deploy.

### If upstream has no changes

1. **Monday 10:00 UTC**: `weekly-upstream-sync.yml` fires, finds `.lastmerge` matches upstream HEAD, closes any stale `upstream-sync` issues. Done.

### Releasing a new version

1. Maintainer triggers `publish-maven.yml` via workflow_dispatch.
2. Changelog is auto-updated with upstream sync SHA from `.lastmerge`.
3. Maven release plugin tags, deploys to Maven Central.
4. GitHub Release is created with auto-generated notes (categorized by label).
5. `deploy-site.yml` publishes versioned docs to GitHub Pages.

---

## Resilience & Edge Cases

| Scenario | Handling |
|---|---|
| Agent fails to port changes | PR stays open with partial work; maintainer can resume manually or re-trigger |
| Test harness doesn't support new RPC methods | Agent marks tests `@Disabled` with a reason, documents the dependency |
| No relevant changes to port | Agent pushes an empty commit explaining why, maintainer closes PR/issue |
| Stale issues accumulate | Weekly workflow auto-closes previous `upstream-sync` issues before creating new ones |
| Multiple sync issues open | Only the most recent issue remains open; older ones are closed with a "superseded" comment |
| Branch name collision | `commit-and-push.sh` appends a numeric suffix automatically |
| CI fails on PR | Standard GitHub flow — agent or maintainer investigates, pushes fixes |

---

## Summary

The `copilot-sdk-java` repository operates a low-toil upstream synchronization loop:

- **Detection** is fully automated via weekly cron
- **Porting** is performed by the Copilot coding agent following structured prompts and shell scripts
- **Validation** is handled by CI (formatting, compilation, tests, Javadoc)
- **Documentation** is auto-deployed on merge and release
- **Release** is a single manual trigger that handles changelog, Maven Central, GitHub Release, and docs

The only recurring human effort is **reviewing and merging the weekly PR** (~10–30 minutes). Everything else — detection, porting, testing, documentation deployment, issue lifecycle management — is automated.
