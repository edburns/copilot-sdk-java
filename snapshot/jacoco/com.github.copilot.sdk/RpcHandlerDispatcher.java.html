<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RpcHandlerDispatcher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GitHub Copilot Community SDK :: Java</a> &gt; <a href="index.source.html" class="el_package">com.github.copilot.sdk</a> &gt; <span class="el_source">RpcHandlerDispatcher.java</span></div><h1>RpcHandlerDispatcher.java</h1><pre class="source lang-java linenums">/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *--------------------------------------------------------------------------------------------*/

package com.github.copilot.sdk;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Map;
import java.util.concurrent.CompletableFuture;
import java.util.logging.Level;
import java.util.logging.Logger;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.github.copilot.sdk.events.AbstractSessionEvent;
import com.github.copilot.sdk.events.SessionEventParser;
import com.github.copilot.sdk.json.PermissionRequestResult;
import com.github.copilot.sdk.json.SessionLifecycleEvent;
import com.github.copilot.sdk.json.SessionLifecycleEventMetadata;
import com.github.copilot.sdk.json.ToolDefinition;
import com.github.copilot.sdk.json.ToolInvocation;
import com.github.copilot.sdk.json.ToolResultObject;
import com.github.copilot.sdk.json.UserInputRequest;

/**
 * Dispatches incoming JSON-RPC method calls to the appropriate handlers.
 * &lt;p&gt;
 * This class handles all server-to-client RPC calls including:
 * &lt;ul&gt;
 * &lt;li&gt;Session events&lt;/li&gt;
 * &lt;li&gt;Tool calls&lt;/li&gt;
 * &lt;li&gt;Permission requests&lt;/li&gt;
 * &lt;li&gt;User input requests&lt;/li&gt;
 * &lt;li&gt;Hooks invocations&lt;/li&gt;
 * &lt;li&gt;Lifecycle events&lt;/li&gt;
 * &lt;/ul&gt;
 */
final class RpcHandlerDispatcher {

<span class="fc" id="L41">    private static final Logger LOG = Logger.getLogger(RpcHandlerDispatcher.class.getName());</span>
<span class="fc" id="L42">    private static final ObjectMapper MAPPER = JsonRpcClient.getObjectMapper();</span>

    private final Map&lt;String, CopilotSession&gt; sessions;
    private final LifecycleEventDispatcher lifecycleDispatcher;

    /**
     * Creates a dispatcher with session registry and lifecycle dispatcher.
     *
     * @param sessions
     *            the session registry to look up sessions by ID
     * @param lifecycleDispatcher
     *            callback for dispatching lifecycle events
     */
<span class="fc" id="L55">    RpcHandlerDispatcher(Map&lt;String, CopilotSession&gt; sessions, LifecycleEventDispatcher lifecycleDispatcher) {</span>
<span class="fc" id="L56">        this.sessions = sessions;</span>
<span class="fc" id="L57">        this.lifecycleDispatcher = lifecycleDispatcher;</span>
<span class="fc" id="L58">    }</span>

    /**
     * Registers all RPC method handlers with the given JSON-RPC client.
     *
     * @param rpc
     *            the JSON-RPC client to register handlers with
     */
    void registerHandlers(JsonRpcClient rpc) {
<span class="fc" id="L67">        rpc.registerMethodHandler(&quot;session.event&quot;, (requestId, params) -&gt; handleSessionEvent(params));</span>
<span class="fc" id="L68">        rpc.registerMethodHandler(&quot;session.lifecycle&quot;, (requestId, params) -&gt; handleLifecycleEvent(params));</span>
<span class="fc" id="L69">        rpc.registerMethodHandler(&quot;tool.call&quot;, (requestId, params) -&gt; handleToolCall(rpc, requestId, params));</span>
<span class="fc" id="L70">        rpc.registerMethodHandler(&quot;permission.request&quot;,</span>
<span class="fc" id="L71">                (requestId, params) -&gt; handlePermissionRequest(rpc, requestId, params));</span>
<span class="fc" id="L72">        rpc.registerMethodHandler(&quot;userInput.request&quot;,</span>
<span class="fc" id="L73">                (requestId, params) -&gt; handleUserInputRequest(rpc, requestId, params));</span>
<span class="fc" id="L74">        rpc.registerMethodHandler(&quot;hooks.invoke&quot;, (requestId, params) -&gt; handleHooksInvoke(rpc, requestId, params));</span>
<span class="fc" id="L75">    }</span>

    private void handleSessionEvent(JsonNode params) {
        try {
<span class="fc" id="L79">            String sessionId = params.get(&quot;sessionId&quot;).asText();</span>
<span class="fc" id="L80">            JsonNode eventNode = params.get(&quot;event&quot;);</span>
<span class="fc" id="L81">            LOG.fine(&quot;Received session.event: &quot; + eventNode);</span>

<span class="fc" id="L83">            CopilotSession session = sessions.get(sessionId);</span>
<span class="pc bpc" id="L84" title="1 of 4 branches missed.">            if (session != null &amp;&amp; eventNode != null) {</span>
<span class="fc" id="L85">                AbstractSessionEvent event = SessionEventParser.parse(eventNode.toString());</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">                if (event != null) {</span>
<span class="fc" id="L87">                    session.dispatchEvent(event);</span>
                }
            }
<span class="nc" id="L90">        } catch (Exception e) {</span>
<span class="nc" id="L91">            LOG.log(Level.SEVERE, &quot;Error handling session event&quot;, e);</span>
<span class="fc" id="L92">        }</span>
<span class="fc" id="L93">    }</span>

    private void handleLifecycleEvent(JsonNode params) {
        try {
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">            String type = params.has(&quot;type&quot;) ? params.get(&quot;type&quot;).asText() : &quot;&quot;;</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">            String sessionId = params.has(&quot;sessionId&quot;) ? params.get(&quot;sessionId&quot;).asText() : &quot;&quot;;</span>

<span class="fc" id="L100">            SessionLifecycleEvent event = new SessionLifecycleEvent();</span>
<span class="fc" id="L101">            event.setType(type);</span>
<span class="fc" id="L102">            event.setSessionId(sessionId);</span>

<span class="pc bpc" id="L104" title="1 of 4 branches missed.">            if (params.has(&quot;metadata&quot;) &amp;&amp; !params.get(&quot;metadata&quot;).isNull()) {</span>
<span class="fc" id="L105">                SessionLifecycleEventMetadata metadata = MAPPER.treeToValue(params.get(&quot;metadata&quot;),</span>
                        SessionLifecycleEventMetadata.class);
<span class="fc" id="L107">                event.setMetadata(metadata);</span>
            }

<span class="fc" id="L110">            lifecycleDispatcher.dispatch(event);</span>
<span class="nc" id="L111">        } catch (Exception e) {</span>
<span class="nc" id="L112">            LOG.log(Level.SEVERE, &quot;Error handling session lifecycle event&quot;, e);</span>
<span class="fc" id="L113">        }</span>
<span class="fc" id="L114">    }</span>

    private void handleToolCall(JsonRpcClient rpc, String requestId, JsonNode params) {
<span class="fc" id="L117">        CompletableFuture.runAsync(() -&gt; {</span>
            try {
<span class="fc" id="L119">                String sessionId = params.get(&quot;sessionId&quot;).asText();</span>
<span class="fc" id="L120">                String toolCallId = params.get(&quot;toolCallId&quot;).asText();</span>
<span class="fc" id="L121">                String toolName = params.get(&quot;toolName&quot;).asText();</span>
<span class="fc" id="L122">                JsonNode arguments = params.get(&quot;arguments&quot;);</span>

<span class="fc" id="L124">                CopilotSession session = sessions.get(sessionId);</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">                if (session == null) {</span>
<span class="nc" id="L126">                    rpc.sendErrorResponse(Long.parseLong(requestId), -32602, &quot;Unknown session &quot; + sessionId);</span>
<span class="nc" id="L127">                    return;</span>
                }

<span class="fc" id="L130">                ToolDefinition tool = session.getTool(toolName);</span>
<span class="pc bpc" id="L131" title="2 of 4 branches missed.">                if (tool == null || tool.getHandler() == null) {</span>
<span class="nc" id="L132">                    var result = new ToolResultObject().setTextResultForLlm(&quot;Tool '&quot; + toolName + &quot;' is not supported.&quot;)</span>
<span class="nc" id="L133">                            .setResultType(&quot;failure&quot;).setError(&quot;tool '&quot; + toolName + &quot;' not supported&quot;);</span>
<span class="nc" id="L134">                    rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, result));</span>
<span class="nc" id="L135">                    return;</span>
                }

<span class="fc" id="L138">                var invocation = new ToolInvocation().setSessionId(sessionId).setToolCallId(toolCallId)</span>
<span class="fc" id="L139">                        .setToolName(toolName).setArguments(arguments);</span>

<span class="fc" id="L141">                tool.getHandler().invoke(invocation).thenAccept(result -&gt; {</span>
                    try {
                        ToolResultObject toolResult;
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">                        if (result instanceof ToolResultObject tr) {</span>
<span class="nc" id="L145">                            toolResult = tr;</span>
                        } else {
<span class="fc" id="L147">                            toolResult = new ToolResultObject().setResultType(&quot;success&quot;).setTextResultForLlm(</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">                                    result instanceof String s ? s : MAPPER.writeValueAsString(result));</span>
                        }
<span class="fc" id="L150">                        rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, toolResult));</span>
<span class="nc" id="L151">                    } catch (Exception e) {</span>
<span class="nc" id="L152">                        LOG.log(Level.SEVERE, &quot;Error sending tool result&quot;, e);</span>
<span class="fc" id="L153">                    }</span>
<span class="fc" id="L154">                }).exceptionally(ex -&gt; {</span>
                    try {
<span class="fc" id="L156">                        var result = new ToolResultObject()</span>
<span class="fc" id="L157">                                .setTextResultForLlm(</span>
                                        &quot;Invoking this tool produced an error. Detailed information is not available.&quot;)
<span class="fc" id="L159">                                .setResultType(&quot;failure&quot;).setError(ex.getMessage());</span>
<span class="fc" id="L160">                        rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, result));</span>
<span class="nc" id="L161">                    } catch (Exception e) {</span>
<span class="nc" id="L162">                        LOG.log(Level.SEVERE, &quot;Error sending tool error&quot;, e);</span>
<span class="fc" id="L163">                    }</span>
<span class="fc" id="L164">                    return null;</span>
                });
<span class="nc" id="L166">            } catch (Exception e) {</span>
<span class="nc" id="L167">                LOG.log(Level.SEVERE, &quot;Error handling tool call&quot;, e);</span>
                try {
<span class="nc" id="L169">                    rpc.sendErrorResponse(Long.parseLong(requestId), -32603, e.getMessage());</span>
<span class="nc" id="L170">                } catch (IOException ioe) {</span>
<span class="nc" id="L171">                    LOG.log(Level.SEVERE, &quot;Failed to send error response&quot;, ioe);</span>
<span class="nc" id="L172">                }</span>
<span class="fc" id="L173">            }</span>
<span class="fc" id="L174">        });</span>
<span class="fc" id="L175">    }</span>

    private void handlePermissionRequest(JsonRpcClient rpc, String requestId, JsonNode params) {
<span class="fc" id="L178">        CompletableFuture.runAsync(() -&gt; {</span>
            try {
<span class="fc" id="L180">                String sessionId = params.get(&quot;sessionId&quot;).asText();</span>
<span class="fc" id="L181">                JsonNode permissionRequest = params.get(&quot;permissionRequest&quot;);</span>

<span class="fc" id="L183">                CopilotSession session = sessions.get(sessionId);</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">                if (session == null) {</span>
<span class="nc" id="L185">                    var result = new PermissionRequestResult()</span>
<span class="nc" id="L186">                            .setKind(&quot;denied-no-approval-rule-and-could-not-request-from-user&quot;);</span>
<span class="nc" id="L187">                    rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, result));</span>
<span class="nc" id="L188">                    return;</span>
                }

<span class="fc" id="L191">                session.handlePermissionRequest(permissionRequest).thenAccept(result -&gt; {</span>
                    try {
<span class="fc" id="L193">                        rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, result));</span>
<span class="nc" id="L194">                    } catch (IOException e) {</span>
<span class="nc" id="L195">                        LOG.log(Level.SEVERE, &quot;Error sending permission result&quot;, e);</span>
<span class="fc" id="L196">                    }</span>
<span class="fc" id="L197">                }).exceptionally(ex -&gt; {</span>
                    try {
<span class="nc" id="L199">                        var result = new PermissionRequestResult()</span>
<span class="nc" id="L200">                                .setKind(&quot;denied-no-approval-rule-and-could-not-request-from-user&quot;);</span>
<span class="nc" id="L201">                        rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, result));</span>
<span class="nc" id="L202">                    } catch (IOException e) {</span>
<span class="nc" id="L203">                        LOG.log(Level.SEVERE, &quot;Error sending permission denied&quot;, e);</span>
<span class="nc" id="L204">                    }</span>
<span class="nc" id="L205">                    return null;</span>
                });
<span class="nc" id="L207">            } catch (Exception e) {</span>
<span class="nc" id="L208">                LOG.log(Level.SEVERE, &quot;Error handling permission request&quot;, e);</span>
<span class="fc" id="L209">            }</span>
<span class="fc" id="L210">        });</span>
<span class="fc" id="L211">    }</span>

    private void handleUserInputRequest(JsonRpcClient rpc, String requestId, JsonNode params) {
<span class="fc" id="L214">        LOG.fine(&quot;Received userInput.request: &quot; + params);</span>
<span class="fc" id="L215">        CompletableFuture.runAsync(() -&gt; {</span>
            try {
<span class="fc" id="L217">                String sessionId = params.get(&quot;sessionId&quot;).asText();</span>
<span class="fc" id="L218">                String question = params.get(&quot;question&quot;).asText();</span>
<span class="fc" id="L219">                LOG.fine(&quot;Processing userInput for session &quot; + sessionId + &quot;, question: &quot; + question);</span>
<span class="fc" id="L220">                JsonNode choicesNode = params.get(&quot;choices&quot;);</span>
<span class="fc" id="L221">                JsonNode allowFreeformNode = params.get(&quot;allowFreeform&quot;);</span>

<span class="fc" id="L223">                CopilotSession session = sessions.get(sessionId);</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">                LOG.fine(&quot;Found session: &quot; + (session != null));</span>
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">                if (session == null) {</span>
<span class="nc" id="L226">                    LOG.fine(&quot;Session not found, sending error&quot;);</span>
<span class="nc" id="L227">                    rpc.sendErrorResponse(Long.parseLong(requestId), -32602, &quot;Unknown session &quot; + sessionId);</span>
<span class="nc" id="L228">                    return;</span>
                }

<span class="fc" id="L231">                var request = new UserInputRequest().setQuestion(question);</span>
<span class="pc bpc" id="L232" title="1 of 4 branches missed.">                if (choicesNode != null &amp;&amp; choicesNode.isArray()) {</span>
<span class="fc" id="L233">                    var choices = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">                    for (JsonNode choice : choicesNode) {</span>
<span class="fc" id="L235">                        choices.add(choice.asText());</span>
<span class="fc" id="L236">                    }</span>
<span class="fc" id="L237">                    request.setChoices(choices);</span>
                }
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">                if (allowFreeformNode != null) {</span>
<span class="fc" id="L240">                    request.setAllowFreeform(allowFreeformNode.asBoolean());</span>
                }

<span class="fc" id="L243">                session.handleUserInputRequest(request).thenAccept(response -&gt; {</span>
                    try {
                        // Ensure answer is never null - CLI requires a non-null string
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">                        String answer = response.getAnswer() != null ? response.getAnswer() : &quot;&quot;;</span>
<span class="fc" id="L247">                        LOG.fine(&quot;Sending userInput response: answer=&quot; + answer + &quot;, wasFreeform=&quot;</span>
<span class="fc" id="L248">                                + response.isWasFreeform());</span>
<span class="fc" id="L249">                        rpc.sendResponse(Long.parseLong(requestId),</span>
<span class="fc" id="L250">                                Map.of(&quot;answer&quot;, answer, &quot;wasFreeform&quot;, response.isWasFreeform()));</span>
<span class="nc" id="L251">                    } catch (IOException e) {</span>
<span class="nc" id="L252">                        LOG.log(Level.SEVERE, &quot;Error sending user input response&quot;, e);</span>
<span class="fc" id="L253">                    }</span>
<span class="fc" id="L254">                }).exceptionally(ex -&gt; {</span>
<span class="nc" id="L255">                    LOG.log(Level.WARNING, &quot;User input handler exception&quot;, ex);</span>
                    try {
<span class="nc" id="L257">                        rpc.sendErrorResponse(Long.parseLong(requestId), -32603,</span>
<span class="nc" id="L258">                                &quot;User input handler error: &quot; + ex.getMessage());</span>
<span class="nc" id="L259">                    } catch (IOException e) {</span>
<span class="nc" id="L260">                        LOG.log(Level.SEVERE, &quot;Error sending user input error&quot;, e);</span>
<span class="nc" id="L261">                    }</span>
<span class="nc" id="L262">                    return null;</span>
                });
<span class="nc" id="L264">            } catch (Exception e) {</span>
<span class="nc" id="L265">                LOG.log(Level.SEVERE, &quot;Error handling user input request&quot;, e);</span>
<span class="fc" id="L266">            }</span>
<span class="fc" id="L267">        });</span>
<span class="fc" id="L268">    }</span>

    private void handleHooksInvoke(JsonRpcClient rpc, String requestId, JsonNode params) {
<span class="fc" id="L271">        CompletableFuture.runAsync(() -&gt; {</span>
            try {
<span class="fc" id="L273">                String sessionId = params.get(&quot;sessionId&quot;).asText();</span>
<span class="fc" id="L274">                String hookType = params.get(&quot;hookType&quot;).asText();</span>
<span class="fc" id="L275">                JsonNode input = params.get(&quot;input&quot;);</span>

<span class="fc" id="L277">                CopilotSession session = sessions.get(sessionId);</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">                if (session == null) {</span>
<span class="nc" id="L279">                    rpc.sendErrorResponse(Long.parseLong(requestId), -32602, &quot;Unknown session &quot; + sessionId);</span>
<span class="nc" id="L280">                    return;</span>
                }

<span class="fc" id="L283">                session.handleHooksInvoke(hookType, input).thenAccept(output -&gt; {</span>
                    try {
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">                        if (output != null) {</span>
<span class="fc" id="L286">                            rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;output&quot;, output));</span>
                        } else {
<span class="nc" id="L288">                            rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;output&quot;, (Object) null));</span>
                        }
<span class="nc" id="L290">                    } catch (IOException e) {</span>
<span class="nc" id="L291">                        LOG.log(Level.SEVERE, &quot;Error sending hooks response&quot;, e);</span>
<span class="fc" id="L292">                    }</span>
<span class="fc" id="L293">                }).exceptionally(ex -&gt; {</span>
                    try {
<span class="fc" id="L295">                        rpc.sendErrorResponse(Long.parseLong(requestId), -32603,</span>
<span class="fc" id="L296">                                &quot;Hooks handler error: &quot; + ex.getMessage());</span>
<span class="nc" id="L297">                    } catch (IOException e) {</span>
<span class="nc" id="L298">                        LOG.log(Level.SEVERE, &quot;Error sending hooks error&quot;, e);</span>
<span class="fc" id="L299">                    }</span>
<span class="fc" id="L300">                    return null;</span>
                });
<span class="nc" id="L302">            } catch (Exception e) {</span>
<span class="nc" id="L303">                LOG.log(Level.SEVERE, &quot;Error handling hooks invoke&quot;, e);</span>
<span class="fc" id="L304">            }</span>
<span class="fc" id="L305">        });</span>
<span class="fc" id="L306">    }</span>

    /**
     * Functional interface for dispatching lifecycle events.
     */
    @FunctionalInterface
    interface LifecycleEventDispatcher {

        void dispatch(SessionLifecycleEvent event);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>