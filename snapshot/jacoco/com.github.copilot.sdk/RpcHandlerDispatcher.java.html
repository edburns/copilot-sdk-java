<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RpcHandlerDispatcher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GitHub Copilot Community SDK :: Java</a> &gt; <a href="index.source.html" class="el_package">com.github.copilot.sdk</a> &gt; <span class="el_source">RpcHandlerDispatcher.java</span></div><h1>RpcHandlerDispatcher.java</h1><pre class="source lang-java linenums">/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *--------------------------------------------------------------------------------------------*/

package com.github.copilot.sdk;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Map;
import java.util.concurrent.CompletableFuture;
import java.util.logging.Level;
import java.util.logging.Logger;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.github.copilot.sdk.events.AbstractSessionEvent;
import com.github.copilot.sdk.events.SessionEventParser;
import com.github.copilot.sdk.json.PermissionRequestResult;
import com.github.copilot.sdk.json.SessionLifecycleEvent;
import com.github.copilot.sdk.json.SessionLifecycleEventMetadata;
import com.github.copilot.sdk.json.ToolDefinition;
import com.github.copilot.sdk.json.ToolInvocation;
import com.github.copilot.sdk.json.ToolResultObject;
import com.github.copilot.sdk.json.UserInputRequest;

/**
 * Dispatches incoming JSON-RPC method calls to the appropriate handlers.
 * &lt;p&gt;
 * This class handles all server-to-client RPC calls including:
 * &lt;ul&gt;
 * &lt;li&gt;Session events&lt;/li&gt;
 * &lt;li&gt;Tool calls&lt;/li&gt;
 * &lt;li&gt;Permission requests&lt;/li&gt;
 * &lt;li&gt;User input requests&lt;/li&gt;
 * &lt;li&gt;Hooks invocations&lt;/li&gt;
 * &lt;li&gt;Lifecycle events&lt;/li&gt;
 * &lt;/ul&gt;
 */
final class RpcHandlerDispatcher {

<span class="fc" id="L42">    private static final Logger LOG = Logger.getLogger(RpcHandlerDispatcher.class.getName());</span>
<span class="fc" id="L43">    private static final ObjectMapper MAPPER = JsonRpcClient.getObjectMapper();</span>

    private final Map&lt;String, CopilotSession&gt; sessions;
    private final LifecycleEventDispatcher lifecycleDispatcher;

    /**
     * Creates a dispatcher with session registry and lifecycle dispatcher.
     *
     * @param sessions
     *            the session registry to look up sessions by ID
     * @param lifecycleDispatcher
     *            callback for dispatching lifecycle events
     */
<span class="fc" id="L56">    RpcHandlerDispatcher(Map&lt;String, CopilotSession&gt; sessions, LifecycleEventDispatcher lifecycleDispatcher) {</span>
<span class="fc" id="L57">        this.sessions = sessions;</span>
<span class="fc" id="L58">        this.lifecycleDispatcher = lifecycleDispatcher;</span>
<span class="fc" id="L59">    }</span>

    /**
     * Registers all RPC method handlers with the given JSON-RPC client.
     *
     * @param rpc
     *            the JSON-RPC client to register handlers with
     */
    void registerHandlers(JsonRpcClient rpc) {
<span class="fc" id="L68">        rpc.registerMethodHandler(&quot;session.event&quot;, (requestId, params) -&gt; handleSessionEvent(params));</span>
<span class="fc" id="L69">        rpc.registerMethodHandler(&quot;session.lifecycle&quot;, (requestId, params) -&gt; handleLifecycleEvent(params));</span>
<span class="fc" id="L70">        rpc.registerMethodHandler(&quot;tool.call&quot;, (requestId, params) -&gt; handleToolCall(rpc, requestId, params));</span>
<span class="fc" id="L71">        rpc.registerMethodHandler(&quot;permission.request&quot;,</span>
<span class="fc" id="L72">                (requestId, params) -&gt; handlePermissionRequest(rpc, requestId, params));</span>
<span class="fc" id="L73">        rpc.registerMethodHandler(&quot;userInput.request&quot;,</span>
<span class="fc" id="L74">                (requestId, params) -&gt; handleUserInputRequest(rpc, requestId, params));</span>
<span class="fc" id="L75">        rpc.registerMethodHandler(&quot;hooks.invoke&quot;, (requestId, params) -&gt; handleHooksInvoke(rpc, requestId, params));</span>
<span class="fc" id="L76">    }</span>

    private void handleSessionEvent(JsonNode params) {
        try {
<span class="fc" id="L80">            String sessionId = params.get(&quot;sessionId&quot;).asText();</span>
<span class="fc" id="L81">            JsonNode eventNode = params.get(&quot;event&quot;);</span>
<span class="fc" id="L82">            LOG.fine(&quot;Received session.event: &quot; + eventNode);</span>

<span class="fc" id="L84">            CopilotSession session = sessions.get(sessionId);</span>
<span class="fc bfc" id="L85" title="All 4 branches covered.">            if (session != null &amp;&amp; eventNode != null) {</span>
<span class="fc" id="L86">                AbstractSessionEvent event = SessionEventParser.parse(eventNode);</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">                if (event != null) {</span>
<span class="fc" id="L88">                    session.dispatchEvent(event);</span>
                }
            }
<span class="nc" id="L91">        } catch (Exception e) {</span>
<span class="nc" id="L92">            LOG.log(Level.SEVERE, &quot;Error handling session event&quot;, e);</span>
<span class="fc" id="L93">        }</span>
<span class="fc" id="L94">    }</span>

    private void handleLifecycleEvent(JsonNode params) {
        try {
<span class="fc bfc" id="L98" title="All 2 branches covered.">            String type = params.has(&quot;type&quot;) ? params.get(&quot;type&quot;).asText() : &quot;&quot;;</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">            String sessionId = params.has(&quot;sessionId&quot;) ? params.get(&quot;sessionId&quot;).asText() : &quot;&quot;;</span>

<span class="fc" id="L101">            SessionLifecycleEvent event = new SessionLifecycleEvent();</span>
<span class="fc" id="L102">            event.setType(type);</span>
<span class="fc" id="L103">            event.setSessionId(sessionId);</span>

<span class="fc bfc" id="L105" title="All 4 branches covered.">            if (params.has(&quot;metadata&quot;) &amp;&amp; !params.get(&quot;metadata&quot;).isNull()) {</span>
<span class="fc" id="L106">                SessionLifecycleEventMetadata metadata = MAPPER.treeToValue(params.get(&quot;metadata&quot;),</span>
                        SessionLifecycleEventMetadata.class);
<span class="fc" id="L108">                event.setMetadata(metadata);</span>
            }

<span class="fc" id="L111">            lifecycleDispatcher.dispatch(event);</span>
<span class="nc" id="L112">        } catch (Exception e) {</span>
<span class="nc" id="L113">            LOG.log(Level.SEVERE, &quot;Error handling session lifecycle event&quot;, e);</span>
<span class="fc" id="L114">        }</span>
<span class="fc" id="L115">    }</span>

    private void handleToolCall(JsonRpcClient rpc, String requestId, JsonNode params) {
<span class="fc" id="L118">        CompletableFuture.runAsync(() -&gt; {</span>
            try {
<span class="fc" id="L120">                String sessionId = params.get(&quot;sessionId&quot;).asText();</span>
<span class="fc" id="L121">                String toolCallId = params.get(&quot;toolCallId&quot;).asText();</span>
<span class="fc" id="L122">                String toolName = params.get(&quot;toolName&quot;).asText();</span>
<span class="fc" id="L123">                JsonNode arguments = params.get(&quot;arguments&quot;);</span>

<span class="fc" id="L125">                CopilotSession session = sessions.get(sessionId);</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">                if (session == null) {</span>
<span class="fc" id="L127">                    rpc.sendErrorResponse(Long.parseLong(requestId), -32602, &quot;Unknown session &quot; + sessionId);</span>
<span class="fc" id="L128">                    return;</span>
                }

<span class="fc" id="L131">                ToolDefinition tool = session.getTool(toolName);</span>
<span class="pc bpc" id="L132" title="1 of 4 branches missed.">                if (tool == null || tool.handler() == null) {</span>
<span class="fc" id="L133">                    var result = new ToolResultObject().setTextResultForLlm(&quot;Tool '&quot; + toolName + &quot;' is not supported.&quot;)</span>
<span class="fc" id="L134">                            .setResultType(&quot;failure&quot;).setError(&quot;tool '&quot; + toolName + &quot;' not supported&quot;);</span>
<span class="fc" id="L135">                    rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, result));</span>
<span class="fc" id="L136">                    return;</span>
                }

<span class="fc" id="L139">                var invocation = new ToolInvocation().setSessionId(sessionId).setToolCallId(toolCallId)</span>
<span class="fc" id="L140">                        .setToolName(toolName).setArguments(arguments);</span>

<span class="fc" id="L142">                tool.handler().invoke(invocation).thenAccept(result -&gt; {</span>
                    try {
                        ToolResultObject toolResult;
<span class="fc bfc" id="L145" title="All 2 branches covered.">                        if (result instanceof ToolResultObject tr) {</span>
<span class="fc" id="L146">                            toolResult = tr;</span>
                        } else {
<span class="fc" id="L148">                            toolResult = new ToolResultObject().setResultType(&quot;success&quot;).setTextResultForLlm(</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">                                    result instanceof String s ? s : MAPPER.writeValueAsString(result));</span>
                        }
<span class="fc" id="L151">                        rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, toolResult));</span>
<span class="nc" id="L152">                    } catch (Exception e) {</span>
<span class="nc" id="L153">                        LOG.log(Level.SEVERE, &quot;Error sending tool result&quot;, e);</span>
<span class="fc" id="L154">                    }</span>
<span class="fc" id="L155">                }).exceptionally(ex -&gt; {</span>
                    try {
<span class="fc" id="L157">                        var result = new ToolResultObject()</span>
<span class="fc" id="L158">                                .setTextResultForLlm(</span>
                                        &quot;Invoking this tool produced an error. Detailed information is not available.&quot;)
<span class="fc" id="L160">                                .setResultType(&quot;failure&quot;).setError(ex.getMessage());</span>
<span class="fc" id="L161">                        rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, result));</span>
<span class="nc" id="L162">                    } catch (Exception e) {</span>
<span class="nc" id="L163">                        LOG.log(Level.SEVERE, &quot;Error sending tool error&quot;, e);</span>
<span class="fc" id="L164">                    }</span>
<span class="fc" id="L165">                    return null;</span>
                });
<span class="nc" id="L167">            } catch (Exception e) {</span>
<span class="nc" id="L168">                LOG.log(Level.SEVERE, &quot;Error handling tool call&quot;, e);</span>
                try {
<span class="nc" id="L170">                    rpc.sendErrorResponse(Long.parseLong(requestId), -32603, e.getMessage());</span>
<span class="nc" id="L171">                } catch (IOException ioe) {</span>
<span class="nc" id="L172">                    LOG.log(Level.SEVERE, &quot;Failed to send error response&quot;, ioe);</span>
<span class="nc" id="L173">                }</span>
<span class="fc" id="L174">            }</span>
<span class="fc" id="L175">        });</span>
<span class="fc" id="L176">    }</span>

    private void handlePermissionRequest(JsonRpcClient rpc, String requestId, JsonNode params) {
<span class="fc" id="L179">        CompletableFuture.runAsync(() -&gt; {</span>
            try {
<span class="fc" id="L181">                String sessionId = params.get(&quot;sessionId&quot;).asText();</span>
<span class="fc" id="L182">                JsonNode permissionRequest = params.get(&quot;permissionRequest&quot;);</span>

<span class="fc" id="L184">                CopilotSession session = sessions.get(sessionId);</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">                if (session == null) {</span>
<span class="fc" id="L186">                    var result = new PermissionRequestResult()</span>
<span class="fc" id="L187">                            .setKind(&quot;denied-no-approval-rule-and-could-not-request-from-user&quot;);</span>
<span class="fc" id="L188">                    rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, result));</span>
<span class="fc" id="L189">                    return;</span>
                }

<span class="fc" id="L192">                session.handlePermissionRequest(permissionRequest).thenAccept(result -&gt; {</span>
                    try {
<span class="fc" id="L194">                        rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, result));</span>
<span class="nc" id="L195">                    } catch (IOException e) {</span>
<span class="nc" id="L196">                        LOG.log(Level.SEVERE, &quot;Error sending permission result&quot;, e);</span>
<span class="fc" id="L197">                    }</span>
<span class="fc" id="L198">                }).exceptionally(ex -&gt; {</span>
                    try {
<span class="nc" id="L200">                        var result = new PermissionRequestResult()</span>
<span class="nc" id="L201">                                .setKind(&quot;denied-no-approval-rule-and-could-not-request-from-user&quot;);</span>
<span class="nc" id="L202">                        rpc.sendResponse(Long.parseLong(requestId), Map.of(&quot;result&quot;, result));</span>
<span class="nc" id="L203">                    } catch (IOException e) {</span>
<span class="nc" id="L204">                        LOG.log(Level.SEVERE, &quot;Error sending permission denied&quot;, e);</span>
<span class="nc" id="L205">                    }</span>
<span class="nc" id="L206">                    return null;</span>
                });
<span class="nc" id="L208">            } catch (Exception e) {</span>
<span class="nc" id="L209">                LOG.log(Level.SEVERE, &quot;Error handling permission request&quot;, e);</span>
<span class="fc" id="L210">            }</span>
<span class="fc" id="L211">        });</span>
<span class="fc" id="L212">    }</span>

    private void handleUserInputRequest(JsonRpcClient rpc, String requestId, JsonNode params) {
<span class="fc" id="L215">        LOG.fine(&quot;Received userInput.request: &quot; + params);</span>
<span class="fc" id="L216">        CompletableFuture.runAsync(() -&gt; {</span>
            try {
<span class="fc" id="L218">                String sessionId = params.get(&quot;sessionId&quot;).asText();</span>
<span class="fc" id="L219">                String question = params.get(&quot;question&quot;).asText();</span>
<span class="fc" id="L220">                LOG.fine(&quot;Processing userInput for session &quot; + sessionId + &quot;, question: &quot; + question);</span>
<span class="fc" id="L221">                JsonNode choicesNode = params.get(&quot;choices&quot;);</span>
<span class="fc" id="L222">                JsonNode allowFreeformNode = params.get(&quot;allowFreeform&quot;);</span>

<span class="fc" id="L224">                CopilotSession session = sessions.get(sessionId);</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">                LOG.fine(&quot;Found session: &quot; + (session != null));</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">                if (session == null) {</span>
<span class="fc" id="L227">                    LOG.fine(&quot;Session not found, sending error&quot;);</span>
<span class="fc" id="L228">                    rpc.sendErrorResponse(Long.parseLong(requestId), -32602, &quot;Unknown session &quot; + sessionId);</span>
<span class="fc" id="L229">                    return;</span>
                }

<span class="fc" id="L232">                var request = new UserInputRequest().setQuestion(question);</span>
<span class="pc bpc" id="L233" title="1 of 4 branches missed.">                if (choicesNode != null &amp;&amp; choicesNode.isArray()) {</span>
<span class="fc" id="L234">                    var choices = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">                    for (JsonNode choice : choicesNode) {</span>
<span class="fc" id="L236">                        choices.add(choice.asText());</span>
<span class="fc" id="L237">                    }</span>
<span class="fc" id="L238">                    request.setChoices(choices);</span>
                }
<span class="fc bfc" id="L240" title="All 2 branches covered.">                if (allowFreeformNode != null) {</span>
<span class="fc" id="L241">                    request.setAllowFreeform(allowFreeformNode.asBoolean());</span>
                }

<span class="fc" id="L244">                session.handleUserInputRequest(request).thenAccept(response -&gt; {</span>
                    try {
                        // Ensure answer is never null - CLI requires a non-null string
<span class="fc bfc" id="L247" title="All 2 branches covered.">                        String answer = response.getAnswer() != null ? response.getAnswer() : &quot;&quot;;</span>
<span class="fc" id="L248">                        LOG.fine(&quot;Sending userInput response: answer=&quot; + answer + &quot;, wasFreeform=&quot;</span>
<span class="fc" id="L249">                                + response.isWasFreeform());</span>
<span class="fc" id="L250">                        rpc.sendResponse(Long.parseLong(requestId),</span>
<span class="fc" id="L251">                                Map.of(&quot;answer&quot;, answer, &quot;wasFreeform&quot;, response.isWasFreeform()));</span>
<span class="nc" id="L252">                    } catch (IOException e) {</span>
<span class="nc" id="L253">                        LOG.log(Level.SEVERE, &quot;Error sending user input response&quot;, e);</span>
<span class="fc" id="L254">                    }</span>
<span class="fc" id="L255">                }).exceptionally(ex -&gt; {</span>
<span class="fc" id="L256">                    LOG.log(Level.WARNING, &quot;User input handler exception&quot;, ex);</span>
                    try {
<span class="fc" id="L258">                        rpc.sendErrorResponse(Long.parseLong(requestId), -32603,</span>
<span class="fc" id="L259">                                &quot;User input handler error: &quot; + ex.getMessage());</span>
<span class="nc" id="L260">                    } catch (IOException e) {</span>
<span class="nc" id="L261">                        LOG.log(Level.SEVERE, &quot;Error sending user input error&quot;, e);</span>
<span class="fc" id="L262">                    }</span>
<span class="fc" id="L263">                    return null;</span>
                });
<span class="nc" id="L265">            } catch (Exception e) {</span>
<span class="nc" id="L266">                LOG.log(Level.SEVERE, &quot;Error handling user input request&quot;, e);</span>
<span class="fc" id="L267">            }</span>
<span class="fc" id="L268">        });</span>
<span class="fc" id="L269">    }</span>

    private void handleHooksInvoke(JsonRpcClient rpc, String requestId, JsonNode params) {
<span class="fc" id="L272">        CompletableFuture.runAsync(() -&gt; {</span>
            try {
<span class="fc" id="L274">                String sessionId = params.get(&quot;sessionId&quot;).asText();</span>
<span class="fc" id="L275">                String hookType = params.get(&quot;hookType&quot;).asText();</span>
<span class="fc" id="L276">                JsonNode input = params.get(&quot;input&quot;);</span>

<span class="fc" id="L278">                CopilotSession session = sessions.get(sessionId);</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">                if (session == null) {</span>
<span class="fc" id="L280">                    rpc.sendErrorResponse(Long.parseLong(requestId), -32602, &quot;Unknown session &quot; + sessionId);</span>
<span class="fc" id="L281">                    return;</span>
                }

<span class="fc" id="L284">                session.handleHooksInvoke(hookType, input).thenAccept(output -&gt; {</span>
                    try {
<span class="fc" id="L286">                        rpc.sendResponse(Long.parseLong(requestId), Collections.singletonMap(&quot;output&quot;, output));</span>
<span class="nc" id="L287">                    } catch (IOException e) {</span>
<span class="nc" id="L288">                        LOG.log(Level.SEVERE, &quot;Error sending hooks response&quot;, e);</span>
<span class="fc" id="L289">                    }</span>
<span class="fc" id="L290">                }).exceptionally(ex -&gt; {</span>
                    try {
<span class="fc" id="L292">                        rpc.sendErrorResponse(Long.parseLong(requestId), -32603,</span>
<span class="fc" id="L293">                                &quot;Hooks handler error: &quot; + ex.getMessage());</span>
<span class="nc" id="L294">                    } catch (IOException e) {</span>
<span class="nc" id="L295">                        LOG.log(Level.SEVERE, &quot;Error sending hooks error&quot;, e);</span>
<span class="fc" id="L296">                    }</span>
<span class="fc" id="L297">                    return null;</span>
                });
<span class="nc" id="L299">            } catch (Exception e) {</span>
<span class="nc" id="L300">                LOG.log(Level.SEVERE, &quot;Error handling hooks invoke&quot;, e);</span>
<span class="fc" id="L301">            }</span>
<span class="fc" id="L302">        });</span>
<span class="fc" id="L303">    }</span>

    /**
     * Functional interface for dispatching lifecycle events.
     */
    @FunctionalInterface
    interface LifecycleEventDispatcher {

        void dispatch(SessionLifecycleEvent event);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>